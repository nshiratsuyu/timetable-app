<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>æˆæ¥­æ¤œç´¢</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* æ¤œç´¢ç”»é¢å°‚ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .search-box {
            text-align: center;
            margin: 20px 0;
        }
        .search-input {
            padding: 10px;
            width: 60%;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .search-btn {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .result-list {
            list-style: none;
            padding: 0;
            max-width: 600px;
            margin: 0 auto;
        }
        .result-item {
            background: white;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .add-btn {
            margin-top: 5px; 
            padding: 5px 10px; 
            background: #008CBA; 
            color: white; 
            border: none; 
            border-radius: 3px; 
            cursor: pointer;
        }
        .add-btn:hover {
            background: #007bb5;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>ğŸ” æˆæ¥­æ¤œç´¢</h1>
    </header>

    <main class="main">
        <div class="search-box">
            <input type="text" id="keyword" class="search-input" placeholder="æˆæ¥­åã‚’å…¥åŠ›ï¼ˆä¾‹: æ•°å­¦ï¼‰">
            <button id="do-search" class="search-btn">æ¤œç´¢</button>
        </div>

        <div id="loading" style="display:none; text-align:center;">æ¤œç´¢ä¸­...</div>
        <ul id="results" class="result-list"></ul>

        <div style="text-align: center; margin-top: 30px;">
            <button onclick="window.location.href='{{ url_for('home') }}'" class="icon-button" style="background:#555;">â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
        </div>
    </main>

    <script>
        // â–¼â–¼â–¼ JavaScript ã“ã“ã‹ã‚‰ â–¼â–¼â–¼
        
        // 1. æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‹•ä½œ
        const searchBtn = document.getElementById('do-search');
        if (searchBtn) {
            searchBtn.addEventListener('click', searchClasses);
        }

        // 2. æ¤œç´¢ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°
        function searchClasses() {
            const keyword = document.getElementById('keyword').value;
            const resultsList = document.getElementById('results');
            const loading = document.getElementById('loading');

            // å‰å›ã®çµæœã‚’æ¶ˆã—ã¦ã€ãƒ­ãƒ¼ãƒ‰ä¸­ã‚’è¡¨ç¤º
            resultsList.innerHTML = '';
            loading.style.display = 'block';

            // APIã«å•ã„åˆã‚ã›
            fetch(`/api/classes?keyword=${keyword}`)
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    
                    if (!data.classes || data.classes.length === 0) {
                        resultsList.innerHTML = '<p style="text-align:center;">è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
                        return;
                    }

                    // çµæœã‚’ãƒªã‚¹ãƒˆè¡¨ç¤º
                    data.classes.forEach(lesson => {
                        const li = document.createElement('li');
                        li.className = 'result-item';
                        // HTMLã®ä¸­ã«ã€Œè¿½åŠ ãƒœã‚¿ãƒ³ã€ã‚’åŸ‹ã‚è¾¼ã‚€
                        li.innerHTML = `
                            <strong>${lesson.name}</strong>
                            <br>
                            <small>${lesson.day}æ›œ ${lesson.period}é™ | ${lesson.teacher}</small>
                            <br>
                            <button class="add-btn" onclick="addTimetable(${lesson.id})">
                                æ™‚é–“å‰²ã«è¿½åŠ 
                            </button>
                        `;
                        resultsList.appendChild(li);
                    });
                })
                .catch(err => {
                    console.error(err);
                    loading.style.display = 'none';
                    alert('æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µãƒ¼ãƒãƒ¼ãŒå‹•ã„ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                });
        }

        // 3. æ™‚é–“å‰²ã«è¿½åŠ ã™ã‚‹é–¢æ•°ï¼ˆã“ã“ãŒé‡è¦ï¼ï¼‰
        function addTimetable(id) {
            fetch('/api/timetable', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ class_id: id })
            })
            .then(response => {
                if (!response.ok) {
                    // ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å ´åˆã‚‚JSONã‚’è§£æã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™
                    return response.json().then(errData => {
                        throw new Error(errData.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert(data.message); // ã€Œè¿½åŠ ã—ã¾ã—ãŸï¼ã€
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message); // ã€Œæ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€ãªã©ãŒã“ã“ã«å‡ºã‚‹
            });
        }
    </script>
</body>
</html>