<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>新規ブログ投稿</title>
</head>
<body>
    <h1>新しいブログを書く</h1>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div style="color: {{ 'red' if category == 'error' else 'green' }};">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="post">
        <p>
            <label>タイトル:<br>
                <input type="text" name="title" required>
            </label>
        </p>
        <p>
            <label>本文:<br>
                <textarea name="body" rows="5" cols="40" required></textarea>
            </label>
        </p>
        <p>
            <label>投稿者名:<br>
                <input type="text" name="user_name" required>
            </label>
        </p>
        <p>
            <button type="submit">投稿する</button>
        </p>
    </form>

    <p><a href="{{ url_for('blogs.index') }}">一覧に戻る</a></p>
</body>
</html>

from flask import Blueprint, render_template, request, redirect, url_for, flash
from flaskr import db
# models.pyのBlogクラスをインポート
from flaskr.models import Blog

blog_bp = Blueprint('blogs', __name__, url_prefix='/blogs')

# 一覧表示
@blog_bp.route('/')
def index():
    blogs = Blog.query.order_by(Blog.created_at.desc()).all()
    return render_template('blogs/index.html', blogs=blogs)

# 新規投稿フォーム表示と投稿処理
@blog_bp.route('/new', methods=['GET', 'POST'])
def create():
    if request.method == 'POST':
        title = request.form['title']
        body = request.form['body']
        user_name = request.form['user_name']

        # DBへ保存
        new_blog = Blog(title=title, body=body, user_name=user_name)
        errors = new_blog.validate()

        if errors:
            for e in errors:
                flash(e, 'error')
            return render_template('blogs/new.html', title=title, body=body, user_name=user_name)

        db.session.add(new_blog)
        db.session.commit()

        # 保存後、詳細ページへリダイレクト
        flash('投稿が完了しました！', 'success')   
        return redirect(url_for('blogs.detail', blog_id=new_blog.id))

    # blogs/new.htmlをテンプレートとしてHTMLを組み立てる
    return render_template('blogs/new.html')

# 詳細ページ
@blog_bp.route('/<int:blog_id>')
def detail(blog_id):
    blog = Blog.query.get_or_404(blog_id)
    return render_template('blogs/detail.html', blog=blog)